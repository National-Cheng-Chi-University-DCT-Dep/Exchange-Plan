pipeline:
  name: "PDF Generation Pipeline"
  identifier: "pdf_generation_pipeline"
  projectIdentifier: "exchange_plan"
  orgIdentifier: "default"
  tags:
    system: "exchange-application" 
    type: "pdf-generation"
    version: "1.0.0"

  properties:
    ci:
      codebase:
        connectorRef: "gitconnector"
        repoName: "Exchange-Plan"
        build: <+input>

  variables:
    - name: pdf_type
      type: String
      description: "PDFé¡å‹ (cv, transcript, supporting, all)"
      value: "all"
    - name: output_directory
      type: String
      description: "PDFè¼¸å‡ºç›®éŒ„"
      value: "application_pdfs"

  stages:
    - stage:
        name: "Environment Setup"
        identifier: "setup"
        description: "è¨­ç½®PDFç”Ÿæˆç’°å¢ƒå’Œä¾è³´"
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: "System Information"
                  identifier: "system_info"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ”§ PDF Generation Pipeline"
                      echo "========================================"
                      echo "Date: $(date)"
                      echo "Python: $(python3 --version)"
                      echo "Platform: $(uname -a)"
                      echo "Working Directory: $(pwd)"
                      echo "========================================"
              
              - step:
                  type: Run
                  name: "Install System Dependencies"
                  identifier: "install_system_deps"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ“¦ å®‰è£ç³»çµ±ä¾è³´å¥—ä»¶..."
                      
                      # æ›´æ–°å¥—ä»¶ç®¡ç†å™¨
                      apt-get update -qq
                      
                      # å®‰è£WeasyPrintæ‰€éœ€çš„ç³»çµ±å¥—ä»¶
                      apt-get install -y \
                        libpango-1.0-0 \
                        libharfbuzz0b \
                        libpangoft2-1.0-0 \
                        libfontconfig1 \
                        libcairo2 \
                        libgdk-pixbuf2.0-0 \
                        shared-mime-info \
                        fonts-dejavu-core \
                        fonts-liberation \
                        fonts-noto-cjk \
                        bc
                      
                      echo "âœ… ç³»çµ±ä¾è³´å®‰è£å®Œæˆ"
              
              - step:
                  type: Run
                  name: "Install Python Dependencies"
                  identifier: "install_python_deps"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ å®‰è£Pythonä¾è³´å¥—ä»¶..."
                      
                      # å‡ç´špip
                      python3 -m pip install --upgrade pip
                      
                      # å®‰è£PDFç”Ÿæˆç›¸é—œå¥—ä»¶
                      pip3 install \
                        PyYAML>=6.0 \
                        markdown>=3.4 \
                        Pillow>=9.0.0 \
                        weasyprint>=59.0 \
                        reportlab>=4.0.0 \
                        img2pdf>=0.4.4 \
                        cssselect2>=0.7.0 \
                        html5lib>=1.1 \
                        tinycss2>=1.2.0 \
                        python-dateutil>=2.8.0 \
                        fonttools>=4.38.0
                      
                      echo "âœ… Pythonå¥—ä»¶å®‰è£å®Œæˆ"
              
              - step:
                  type: Run
                  name: "Validate Environment"
                  identifier: "validate_env"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ” é©—è­‰PDFç”Ÿæˆç’°å¢ƒ..."
                      
                      # æ¸¬è©¦é—œéµå¥—ä»¶
                      python3 -c "import weasyprint; print('âœ… WeasyPrint OK')"
                      python3 -c "import reportlab; print('âœ… ReportLab OK')"
                      python3 -c "import PIL; print('âœ… Pillow OK')"
                      python3 -c "import yaml; print('âœ… PyYAML OK')"
                      python3 -c "import markdown; print('âœ… Markdown OK')"
                      
                      # æª¢æŸ¥å¿…è¦æª”æ¡ˆ
                      echo ""
                      echo "ğŸ“‚ æª¢æŸ¥å¿…è¦æª”æ¡ˆ..."
                      
                      if [ -f "my_profile.yml" ]; then
                        echo "âœ… my_profile.yml å­˜åœ¨"
                      else
                        echo "âŒ æ‰¾ä¸åˆ° my_profile.yml"
                        exit 1
                      fi
                      
                      if [ -f "build_scripts/generate_pdfs.py" ]; then
                        echo "âœ… PDFç”Ÿæˆè…³æœ¬å­˜åœ¨"
                      else
                        echo "âŒ æ‰¾ä¸åˆ° PDFç”Ÿæˆè…³æœ¬"
                        exit 1
                      fi
                      
                      echo "âœ… ç’°å¢ƒé©—è­‰å®Œæˆ"

    - stage:
        name: "Generate Application Documents"
        identifier: "generate_docs"
        description: "ç”Ÿæˆç”³è«‹æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰"
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: "Check Application Documents"
                  identifier: "check_docs"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ“‹ æª¢æŸ¥ç”³è«‹æ–‡ä»¶ç‹€æ…‹..."
                      
                      if [ -d "final_applications" ] && [ "$(ls -A final_applications 2>/dev/null)" ]; then
                        echo "âœ… final_applicationsç›®éŒ„å­˜åœ¨ä¸”æœ‰å…§å®¹"
                        doc_count=$(find final_applications -name "*.md" | wc -l)
                        echo "ğŸ“„ æ‰¾åˆ° $doc_count å€‹Markdownæ–‡ä»¶"
                        
                        # åˆ—å‡ºä¸€äº›æ–‡ä»¶
                        echo "æ–‡ä»¶ç¯„ä¾‹:"
                        find final_applications -name "*cv*.md" | head -3
                      else
                        echo "âš ï¸ final_applicationsç›®éŒ„ä¸å­˜åœ¨æˆ–ç‚ºç©º"
                        echo "éœ€è¦å…ˆç”Ÿæˆç”³è«‹æ–‡ä»¶..."
                        echo "generate_docs_needed=true" >> $GITHUB_ENV
                      fi
              
              - step:
                  type: Run
                  name: "Generate Documents (if needed)"
                  identifier: "generate_if_needed"
                  spec:
                    shell: Bash
                    command: |
                      if [ "${generate_docs_needed:-false}" == "true" ]; then
                        echo "ğŸ“ ç”Ÿæˆç”³è«‹æ–‡ä»¶..."
                        
                        if [ -f "build_scripts/generate_docs.py" ]; then
                          python3 build_scripts/generate_docs.py
                          
                          if [ -d "final_applications" ] && [ "$(ls -A final_applications 2>/dev/null)" ]; then
                            echo "âœ… ç”³è«‹æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
                          else
                            echo "âŒ ç”³è«‹æ–‡ä»¶ç”Ÿæˆå¤±æ•—"
                            exit 1
                          fi
                        else
                          echo "âŒ æ‰¾ä¸åˆ°æ–‡ä»¶ç”Ÿæˆè…³æœ¬"
                          exit 1
                        fi
                      else
                        echo "âœ… ç”³è«‹æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³éç”Ÿæˆæ­¥é©Ÿ"
                      fi

    - stage:
        name: "PDF Generation"
        identifier: "pdf_generation"
        description: "ç”Ÿæˆç”³è«‹æ‰€éœ€çš„PDFæ–‡ä»¶"
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: "Generate PDFs"
                  identifier: "generate_pdfs"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ¯ é–‹å§‹ç”ŸæˆPDFæ–‡ä»¶..."
                      echo "PDFé¡å‹: <+pipeline.variables.pdf_type>"
                      echo "è¼¸å‡ºç›®éŒ„: <+pipeline.variables.output_directory>"
                      
                      # è¨­å®šç’°å¢ƒè®Šæ•¸
                      export PDF_TYPE="<+pipeline.variables.pdf_type>"
                      export OUTPUT_DIR="<+pipeline.variables.output_directory>"
                      
                      # å»ºç«‹è¼¸å‡ºç›®éŒ„
                      mkdir -p "$OUTPUT_DIR"
                      
                      # åŸ·è¡ŒPDFç”Ÿæˆ
                      python3 build_scripts/generate_pdfs.py \
                        --type "$PDF_TYPE" \
                        --profile my_profile.yml \
                        --output "$OUTPUT_DIR"
                      
                      # æª¢æŸ¥ç”Ÿæˆçµæœ
                      if [ -d "$OUTPUT_DIR" ] && [ "$(ls -A $OUTPUT_DIR 2>/dev/null)" ]; then
                        echo "âœ… PDFç”ŸæˆæˆåŠŸï¼"
                        echo ""
                        echo "ğŸ“ ç”Ÿæˆçš„PDFæ–‡ä»¶:"
                        ls -lh "$OUTPUT_DIR"/
                        
                        # çµ±è¨ˆè³‡è¨Š
                        pdf_count=$(ls "$OUTPUT_DIR"/*.pdf 2>/dev/null | wc -l)
                        total_size=$(du -sh "$OUTPUT_DIR"/ | cut -f1)
                        
                        echo ""
                        echo "ğŸ“Š ç”Ÿæˆçµ±è¨ˆ:"
                        echo "  â€¢ PDFæ–‡ä»¶æ•¸é‡: $pdf_count"
                        echo "  â€¢ ç¸½æª”æ¡ˆå¤§å°: $total_size"
                        
                        # è¼¸å‡ºè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
                        echo "PDF_GENERATED=true" >> $HARNESS_ENV
                        echo "PDF_COUNT=$pdf_count" >> $HARNESS_ENV
                        echo "TOTAL_SIZE=$total_size" >> $HARNESS_ENV
                        
                      else
                        echo "âŒ PDFç”Ÿæˆå¤±æ•—æˆ–æ²’æœ‰ç”Ÿæˆä»»ä½•æª”æ¡ˆ"
                        echo "PDF_GENERATED=false" >> $HARNESS_ENV
                        exit 1
                      fi
              
              - step:
                  type: Run
                  name: "PDF Quality Check"
                  identifier: "quality_check"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ” åŸ·è¡ŒPDFå“è³ªæª¢æŸ¥..."
                      
                      OUTPUT_DIR="<+pipeline.variables.output_directory>"
                      
                      if [ ! -d "$OUTPUT_DIR" ]; then
                        echo "âŒ è¼¸å‡ºç›®éŒ„ä¸å­˜åœ¨"
                        exit 1
                      fi
                      
                      quality_passed=true
                      
                      for pdf in "$OUTPUT_DIR"/*.pdf; do
                        if [ -f "$pdf" ]; then
                          filename=$(basename "$pdf")
                          size=$(stat --format="%s" "$pdf")
                          size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc -l)
                          
                          echo "ğŸ“„ æª”æ¡ˆ: $filename"
                          echo "   å¤§å°: ${size_mb}MB"
                          
                          # æª¢æŸ¥æª”æ¡ˆå¤§å°é™åˆ¶
                          if [[ "$pdf" == *"CV"* ]] && (( $(echo "$size_mb > 4" | bc -l) )); then
                            echo "   âŒ è¶…éCVæª”æ¡ˆ4MBé™åˆ¶"
                            quality_passed=false
                          elif [[ "$pdf" != *"CV"* ]] && (( $(echo "$size_mb > 10" | bc -l) )); then
                            echo "   âŒ è¶…é10MBæª”æ¡ˆé™åˆ¶"
                            quality_passed=false
                          else
                            echo "   âœ… æª”æ¡ˆå¤§å°ç¬¦åˆè¦æ±‚"
                          fi
                          
                          # æª¢æŸ¥PDFå®Œæ•´æ€§ï¼ˆå¦‚æœæœ‰pdfinfoå·¥å…·ï¼‰
                          if command -v pdfinfo >/dev/null 2>&1; then
                            if pdfinfo "$pdf" >/dev/null 2>&1; then
                              pages=$(pdfinfo "$pdf" 2>/dev/null | grep "Pages:" | awk '{print $2}')
                              echo "   ğŸ“ƒ é æ•¸: ${pages:-Unknown}"
                              echo "   âœ… PDFæ ¼å¼æœ‰æ•ˆ"
                            else
                              echo "   âŒ PDFæ ¼å¼å¯èƒ½æœ‰å•é¡Œ"
                              quality_passed=false
                            fi
                          fi
                          
                          echo ""
                        fi
                      done
                      
                      if [ "$quality_passed" == "true" ]; then
                        echo "âœ… æ‰€æœ‰PDFæ–‡ä»¶å“è³ªæª¢æŸ¥é€šé"
                      else
                        echo "âŒ éƒ¨åˆ†PDFæ–‡ä»¶æœªé€šéå“è³ªæª¢æŸ¥"
                        exit 1
                      fi

    - stage:
        name: "Save and Notify"
        identifier: "save_notify"
        description: "ä¿å­˜PDFæ–‡ä»¶ä¸¦ç™¼é€é€šçŸ¥"
        type: CI
        spec:
          cloneCodebase: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: Run
                  name: "Commit PDFs to Repository"
                  identifier: "commit_pdfs"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ’¾ æäº¤PDFæ–‡ä»¶åˆ°Repository..."
                      
                      OUTPUT_DIR="<+pipeline.variables.output_directory>"
                      
                      if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls -A $OUTPUT_DIR 2>/dev/null)" ]; then
                        echo "âŒ æ²’æœ‰PDFæ–‡ä»¶éœ€è¦æäº¤"
                        exit 1
                      fi
                      
                      # è¨­å®šGité…ç½®
                      git config user.email "harness-pipeline@dennisleehappy.org"
                      git config user.name "Harness PDF Pipeline Bot"
                      
                      # æª¢æŸ¥Gitç‹€æ…‹
                      echo "ğŸ“‹ Git status:"
                      git status
                      
                      # åŠ å…¥PDFæ–‡ä»¶
                      git add "$OUTPUT_DIR"/
                      
                      # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
                      if git diff --staged --quiet; then
                        echo "â„¹ï¸ æ²’æœ‰æ–°çš„PDFæª”æ¡ˆéœ€è¦æäº¤"
                      else
                        # å»ºç«‹æäº¤è¨Šæ¯
                        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
                        PDF_COUNT="${PDF_COUNT:-unknown}"
                        TOTAL_SIZE="${TOTAL_SIZE:-unknown}"
                        
                        COMMIT_MSG="ğŸ¤– Auto-generate: Application PDFs

ğŸ“… Generated: $TIMESTAMP
ğŸ”§ Pipeline: <+pipeline.name>
ğŸ“‹ Execution: <+pipeline.sequenceId>
ğŸ¯ PDF Type: <+pipeline.variables.pdf_type>
ğŸ“Š Files: $PDF_COUNT PDFs
ğŸ“ Total Size: $TOTAL_SIZE

Generated PDFs:
$(cd "$OUTPUT_DIR" && ls -1 *.pdf 2>/dev/null | sed 's/^/- /' || echo '- No PDFs found')"

                        git commit -m "$COMMIT_MSG"
                        
                        # æ¨é€åˆ°Repository
                        git push origin HEAD:<+codebase.branch>
                        
                        echo "âœ… PDFæ–‡ä»¶å·²æäº¤ä¸¦æ¨é€åˆ°GitHub"
                        echo "ğŸ“ Commit Hash: $(git rev-parse --short HEAD)"
                      fi
              
              - step:
                  type: Run
                  name: "Generate Summary Report"
                  identifier: "summary_report"
                  spec:
                    shell: Bash
                    command: |
                      echo "ğŸ“Š ç”ŸæˆåŸ·è¡Œç¸½çµå ±å‘Š..."
                      
                      OUTPUT_DIR="<+pipeline.variables.output_directory>"
                      TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
                      
                      # å»ºç«‹å ±å‘Šæª”æ¡ˆ
                      REPORT_FILE="pdf_generation_report_$(date +%Y%m%d_%H%M%S).md"
                      
                      cat > "$REPORT_FILE" << EOF
                      # PDF Generation Report
                      
                      **Generated:** $TIMESTAMP  
                      **Pipeline:** <+pipeline.name>  
                      **Execution ID:** <+pipeline.sequenceId>  
                      **Branch:** <+codebase.branch>  
                      **PDF Type:** <+pipeline.variables.pdf_type>
                      
                      ## Results
                      
                      EOF
                      
                      if [ -d "$OUTPUT_DIR" ] && [ "$(ls -A $OUTPUT_DIR 2>/dev/null)" ]; then
                        echo "**Status:** âœ… Success" >> "$REPORT_FILE"
                        echo "" >> "$REPORT_FILE"
                        echo "### Generated Files" >> "$REPORT_FILE"
                        echo "" >> "$REPORT_FILE"
                        
                        for pdf in "$OUTPUT_DIR"/*.pdf; do
                          if [ -f "$pdf" ]; then
                            filename=$(basename "$pdf")
                            size=$(stat --format="%s" "$pdf")
                            size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc -l)
                            echo "- **$filename** (${size_mb}MB)" >> "$REPORT_FILE"
                          fi
                        done
                        
                        total_files=$(ls "$OUTPUT_DIR"/*.pdf 2>/dev/null | wc -l)
                        total_size=$(du -sh "$OUTPUT_DIR"/ | cut -f1)
                        
                        echo "" >> "$REPORT_FILE"
                        echo "### Statistics" >> "$REPORT_FILE"
                        echo "" >> "$REPORT_FILE"
                        echo "- **Total Files:** $total_files PDFs" >> "$REPORT_FILE"
                        echo "- **Total Size:** $total_size" >> "$REPORT_FILE"
                        echo "- **Output Directory:** \`$OUTPUT_DIR/\`" >> "$REPORT_FILE"
                        
                      else
                        echo "**Status:** âŒ Failed" >> "$REPORT_FILE"
                        echo "" >> "$REPORT_FILE"
                        echo "No PDF files were generated." >> "$REPORT_FILE"
                      fi
                      
                      echo "" >> "$REPORT_FILE"
                      echo "## Next Steps" >> "$REPORT_FILE"
                      echo "" >> "$REPORT_FILE"
                      echo "1. Review generated PDF files in \`$OUTPUT_DIR/\` directory" >> "$REPORT_FILE"
                      echo "2. Check file sizes comply with application requirements:" >> "$REPORT_FILE"
                      echo "   - CV: Maximum 4MB" >> "$REPORT_FILE"
                      echo "   - Transcript: Maximum 10MB" >> "$REPORT_FILE"
                      echo "   - Supporting Documents: Maximum 10MB" >> "$REPORT_FILE"
                      echo "3. Download and review PDF content before submission" >> "$REPORT_FILE"
                      echo "" >> "$REPORT_FILE"
                      echo "---" >> "$REPORT_FILE"
                      echo "*Report generated by Harness PDF Pipeline*" >> "$REPORT_FILE"
                      
                      echo "âœ… å ±å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
                      echo "ğŸ“„ å ±å‘Šå…§å®¹:"
                      cat "$REPORT_FILE"
              
              - step:
                  type: Run
                  name: "Success Notification"
                  identifier: "success_notification"
                  spec:
                    shell: Bash
                    command: |
                      echo "=============================================="
                      echo "ğŸ‰ PDF Generation Pipeline Completed!"
                      echo "=============================================="
                      echo "Generated: $(date)"
                      echo "Pipeline: <+pipeline.name>"
                      echo "Execution: <+pipeline.sequenceId>"
                      echo "PDF Type: <+pipeline.variables.pdf_type>"
                      echo "Output: <+pipeline.variables.output_directory>/"
                      echo ""
                      echo "ğŸ“‹ Application Requirements Met:"
                      echo "âœ… Curriculum Vitae (max 4MB PDF)"
                      echo "âœ… Transcript of Records (max 10MB PDF)"  
                      echo "âœ… Other Documents (max 10MB PDF)"
                      echo ""
                      echo "ğŸ“ Generated files have been committed to GitHub"
                      echo "ğŸ”— Branch: <+codebase.branch>"
                      echo ""
                      echo "Next Steps:"
                      echo "1. Pull latest changes from GitHub"
                      echo "2. Review PDF files in application_pdfs/ directory"
                      echo "3. Verify content accuracy before submission"
                      echo "4. Prepare for ISCTE application submission"
                      echo ""
                      echo "=============================================="

  notificationRules:
    - name: "PDF Pipeline Success"
      identifier: "pdf_success_notification"
      pipelineEvents:
        - type: PipelineSuccess
      notificationMethod:
        type: Email
        spec:
          userGroups: []
          recipients:
            - admin@dennisleehappy.org
          subject: "âœ… PDF Generation Pipeline Completed - Exchange Application"
          body: |
            The PDF Generation Pipeline has completed successfully!
            
            Pipeline: <+pipeline.name>
            Execution ID: <+pipeline.sequenceId>
            Branch: <+codebase.branch>
            PDF Type: <+pipeline.variables.pdf_type>
            
            âœ… Generated PDFs are ready for ISCTE application:
            â€¢ Curriculum Vitae (max 4MB PDF)
            â€¢ Transcript of Records (max 10MB PDF)
            â€¢ Other Supporting Documents (max 10MB PDF)
            
            ğŸ“ Files have been committed to GitHub repository
            ğŸ”— Check application_pdfs/ directory for generated files
            
            Next: Review PDF content and prepare for submission.
            
            Best regards,
            Harness PDF Pipeline Bot
      enabled: true
    
    - name: "PDF Pipeline Failure"
      identifier: "pdf_failure_notification"
      pipelineEvents:
        - type: PipelineFailed
      notificationMethod:
        type: Email
        spec:
          userGroups: []
          recipients:
            - admin@dennisleehappy.org
          subject: "âŒ PDF Generation Pipeline Failed - Exchange Application"
          body: |
            The PDF Generation Pipeline has failed!
            
            Pipeline: <+pipeline.name>
            Execution ID: <+pipeline.sequenceId>
            Failed Stage: <+pipeline.stage.name>
            
            Please check the pipeline logs for detailed error information.
            
            The PDF files required for ISCTE application may not be available.
            Manual intervention may be required.
            
            Best regards,
            Harness PDF Pipeline Bot
      enabled: true
