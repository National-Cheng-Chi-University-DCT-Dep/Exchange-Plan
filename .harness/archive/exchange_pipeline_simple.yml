pipeline:
  name: "Exchange Application Pipeline"
  identifier: "exchange_application_pipeline"
  description: "自動化交換申請文件生成與資格驗證流程"
  
  stages:
    - stage:
        name: "Validate and Generate"
        identifier: "validate_and_generate"
        type: "CI"
        description: "驗證資格並生成申請文件"
        
        spec:
          infrastructure:
            type: "UseFromStage"
            spec:
              useFromStage: "validate_and_generate"
        
          execution:
            steps:
              - step:
                  name: "Setup Environment"
                  identifier: "setup_env"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      python3 --version || python --version
                      pip3 --version || pip --version
                      pip3 install pyyaml || pip install pyyaml
                      
              - step:
                  name: "Run Eligibility Validation"
                  identifier: "run_validation"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      python3 intelligence_gathering/validator.py || python intelligence_gathering/validator.py
                      
              - step:
                  name: "Generate Application Documents"
                  identifier: "generate_docs"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      python3 build_scripts/generate_docs.py || python build_scripts/generate_docs.py
                      
              - step:
                  name: "Quality Check"
                  identifier: "quality_check"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      if [ ! -f "final_applications/eligibility_report.md" ]; then
                        echo "資格報告未生成"
                        exit 1
                      fi
                      
                      if [ ! -f "final_applications/dashboard.md" ]; then
                        echo "儀表板未生成"
                        exit 1
                      fi
                      
                      doc_count=$(find final_applications -name "*_study_plan_*.md" | wc -l)
                      echo "已生成 $doc_count 份讀書計畫"
                      
                      if [ $doc_count -eq 0 ]; then
                        echo "未生成任何申請文件"
                        exit 1
                      fi
                      
                      echo "文件完整性檢查通過"
                      
              - step:
                  name: "Success Notification"
                  identifier: "success_notification"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "=========================================="
                      echo "交換申請文件生成完成！"
                      echo "=========================================="
                      echo "生成時間: $(date)"
                      echo "文件位置: final_applications/"
                      echo "儀表板: final_applications/dashboard.md"
                      echo ""
                      echo "下一步建議:"
                      echo "1. 檢查各校申請截止日期"
                      echo "2. 準備英語檢定成績"
                      echo "3. 聯繫推薦人撰寫推薦信"
                      echo ""
                      echo "---"
                      echo "此通知由 ExchangeApp-IAC 自動發送"
                      echo "=========================================="
        
        failureStrategies:
          - onFailure:
              errors:
                - "AllErrors"
              action:
                type: "Ignore"
                spec: {}

  variables:
    - name: "profile_file"
      type: "String"
      value: "my_profile.yml"
      
    - name: "output_directory"
      type: "String"
      value: "final_applications"
      
    - name: "template_directory"
      type: "String"
      value: "templates"

  failureStrategies:
    - onFailure:
        errors:
          - "AllErrors"
        action:
          type: "Ignore"
          spec: {}