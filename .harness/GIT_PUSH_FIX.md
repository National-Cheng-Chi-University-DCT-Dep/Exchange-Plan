# 🔧 Git Push 失敗問題修正指南

## ❌ 問題描述

```
fatal: could not read Username for 'https://github.com': No such device or address
```

## 🔍 原因分析

這個錯誤表示Git無法讀取GitHub認證資訊。在Harness Pipeline中使用HTTPS push時，需要配置認證。

## ✅ 解決方案

### 方案 1: 在Harness中配置Personal Access Token ⭐ **推薦**

#### 步驟 1: 在GitHub生成Personal Access Token

1. 登入GitHub
2. 前往 **Settings** > **Developer settings** > **Personal access tokens** > **Tokens (classic)**
3. 點擊 **Generate new token (classic)**
4. 設置:
   - **Note**: `Harness Pipeline - Exchange-Plan`
   - **Expiration**: 90 days 或 No expiration
   - **Scopes**: 勾選 `repo` (完整權限)
5. 生成並**複製token**（只會顯示一次！）

#### 步驟 2: 在Harness中保存Token

1. 前往Harness
2. **Project Settings** > **Secrets**
3. 創建新Secret:
   - Name: `github_pat`
   - Type: `Text`
   - Value: [貼上您的GitHub PAT]
4. 保存

#### 步驟 3: 更新Pipeline配置

更新`.harness/exchange_pipeline_verified.yml`中的git push命令：

```yaml
- step:
    type: "Run"
    name: "Commit and Push Results to GitHub"
    identifier: "commit_push"
    spec:
      shell: "Bash"
      command: |
        # Configure git with token
        git config user.email "harness-pipeline@dennisleehappy.org"
        git config user.name "Harness Pipeline Bot"
        
        # Set up authentication using token
        git remote set-url origin https://<+secrets.getValue("github_pat")>@github.com/National-Cheng-Chi-University-DCT-Dep/Exchange-Plan.git
        
        # Add and commit files
        if [ -d "final_applications" ] && [ "$(ls -A final_applications 2>/dev/null)" ]; then
          git add final_applications/
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
            git commit -m "feat: Generate exchange application documents - $TIMESTAMP"
            
            # Push with authentication
            git push origin HEAD:main
            
            echo "✅ Successfully pushed to GitHub!"
          fi
        fi
```

### 方案 2: 使用SSH Key

#### 步驟 1: 生成SSH Key

```bash
ssh-keygen -t ed25519 -C "harness-pipeline@dennisleehappy.org"
```

#### 步驟 2: 添加SSH Key到GitHub

1. 複製公鑰內容
2. 前往GitHub Settings > SSH and GPG keys
3. 添加新SSH key

#### 步驟 3: 在Harness中保存私鑰

1. 創建SSH Key類型的Secret
2. 名稱: `github_ssh_key`
3. 貼上私鑰

#### 步驟 4: 更新GitHub Connector

1. 編輯`gitconnector`
2. 將URL改為SSH格式:
   ```
   git@github.com:National-Cheng-Chi-University-DCT-Dep/Exchange-Plan.git
   ```
3. 選擇SSH Key認證
4. 使用`github_ssh_key` secret

### 方案 3: 暫時跳過Push（用於測試）

如果只是想測試Pipeline功能，可以暫時註解掉push命令：

```yaml
# Push to GitHub
# git push origin HEAD:main  # ← 暫時註解
echo "⚠️ Git push skipped (for testing)"
```

這樣文件會commit到本地，但不會push。您可以在Harness UI中下載artifacts。

## 🎯 推薦的完整修正方案

### 使用Personal Access Token（最簡單）

更新`exchange_pipeline_verified.yml`的commit步驟：

```yaml
- step:
    type: "Run"
    name: "Commit and Push Results to GitHub"
    identifier: "commit_push"
    spec:
      shell: "Bash"
      envVariables:
        GITHUB_TOKEN: <+secrets.getValue("github_pat")>
      command: |
        echo "Committing generated files to GitHub..."
        
        # Configure git
        git config user.email "harness-pipeline@dennisleehappy.org"
        git config user.name "Harness Pipeline Bot"
        
        # Use token for authentication
        git remote set-url origin https://${GITHUB_TOKEN}@github.com/National-Cheng-Chi-University-DCT-Dep/Exchange-Plan.git
        
        # Add and commit
        if [ -d "final_applications" ] && [ "$(ls -A final_applications 2>/dev/null)" ]; then
          git add final_applications/
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date '+%Y%m%d_%H%M%S')
            git commit -m "feat: Generate exchange application documents - $TIMESTAMP

Generated by Harness Pipeline
Pipeline ID: <+pipeline.sequenceId>
Execution Time: <+pipeline.startTs>"
            
            # Push with token auth
            git push origin HEAD:main
            
            echo "✅ Successfully pushed documents to GitHub!"
            echo "Commit: $(git rev-parse --short HEAD)"
          else
            echo "ℹ️ No changes to commit"
          fi
        else
          echo "⚠️ No documents to commit"
        fi
```

## 📋 驗證步驟

1. **創建GitHub PAT** ✅
2. **在Harness中保存為Secret** ✅
3. **更新Pipeline配置** ✅
4. **測試執行Pipeline** 🔄
5. **確認文件成功push到GitHub** ✅

## 🆘 如果仍然失敗

### 檢查事項

1. **Token權限**: 確認PAT有`repo`權限
2. **Token有效期**: 確認token未過期
3. **Secret名稱**: 確認Pipeline中的secret名稱與Harness中一致
4. **Repository URL**: 確認URL格式正確

### 調試命令

在Pipeline中添加調試輸出：

```bash
# Test git authentication
git ls-remote origin &> /dev/null && echo "✅ Git authentication successful" || echo "❌ Git authentication failed"
```

---

**使用Personal Access Token是最簡單可靠的解決方案！** 🚀

