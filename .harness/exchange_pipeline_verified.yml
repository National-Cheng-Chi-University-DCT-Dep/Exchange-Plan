pipeline:
  name: "Exchange Application Pipeline"
  identifier: "exchange_application_pipeline"
  projectIdentifier: "exchange_plan"
  orgIdentifier: "default"
  tags: 
    system: "exchange-application"
    version: "1.0.0"
  
  properties:
    ci:
      codebase:
        connectorRef: "github_connector"
        repoName: "Exchange-Plan"
        build: <+input>

  stages:
    - stage:
        name: "Environment Setup"
        identifier: "setup"
        description: "Setup Python environment and install dependencies"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "System Information"
                  identifier: "system_info"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîß Exchange Application System Setup"
                      echo "Date: $(date)"
                      echo "Python version: $(python3 --version)"
                      echo "Pip version: $(pip3 --version)"
                      echo "Git commit: $(git rev-parse --short HEAD)"
                      
              - step:
                  type: "Run"
                  name: "Install Dependencies"
                  identifier: "install_deps"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üì¶ Installing Python dependencies..."
                      
                      # Install core dependencies
                      pip3 install --upgrade pip
                      pip3 install PyYAML
                      
                      echo "‚úÖ Dependencies installed"
                      
                      echo "üìã Installed packages:"
                      pip3 list | grep -E "(PyYAML)"

    - stage:
        name: "Validation and Generation"
        identifier: "validation_generation"
        description: "Validate eligibility and generate application documents"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Validate Configuration"
                  identifier: "validate_config"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîç Validating system configuration..."
                      
                      # Check if required files exist
                      if [ ! -f "my_profile.yml" ]; then
                        echo "‚ùå my_profile.yml not found"
                        exit 1
                      fi
                      
                      if [ ! -f "source_data/university_level_options.yml" ]; then
                        echo "‚ùå university_level_options.yml not found"
                        exit 1
                      fi
                      
                      if [ ! -f "source_data/college_level_options.yml" ]; then
                        echo "‚ùå college_level_options.yml not found"
                        exit 1
                      fi
                      
                      # Validate YAML syntax
                      python3 -c "import yaml; yaml.safe_load(open('my_profile.yml'))"
                      echo "‚úÖ my_profile.yml is valid"
                      
                      python3 -c "import yaml; yaml.safe_load(open('source_data/university_level_options.yml'))"
                      echo "‚úÖ university_level_options.yml is valid"
                      
                      python3 -c "import yaml; yaml.safe_load(open('source_data/college_level_options.yml'))"
                      echo "‚úÖ college_level_options.yml is valid"
                      
              - step:
                  type: "Run"
                  name: "Run Eligibility Validation"
                  identifier: "run_validation"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "‚úÖ Starting eligibility validation..."
                      
                      export PYTHONPATH="${PYTHONPATH}:$(pwd)"
                      
                      echo "üîç Running application eligibility validator..."
                      python3 intelligence_gathering/validator.py
                      
                      # Check validation results
                      if [ -f "final_applications/eligibility_report.md" ]; then
                        echo "‚úÖ Validation completed successfully"
                        echo "üìä Validation summary:"
                        head -20 final_applications/eligibility_report.md
                      else
                        echo "‚ùå Validation failed"
                        exit 1
                      fi
                      
              - step:
                  type: "Run"
                  name: "Generate Application Documents"
                  identifier: "generate_docs"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üìù Generating customized application documents..."
                      
                      export PYTHONPATH="${PYTHONPATH}:$(pwd)"
                      
                      echo "üìù Running document generator..."
                      python3 build_scripts/generate_docs.py
                      
                      # Document generation summary
                      echo "üìä Document Generation Summary:"
                      find final_applications -name "*_study_plan_*.md" | wc -l | xargs echo "  Study plans generated:"
                      find final_applications -name "*_cv_*.md" | wc -l | xargs echo "  CV documents generated:"
                      
                      if [ -f "final_applications/dashboard.md" ]; then
                        echo "‚úÖ Dashboard generated successfully"
                      else
                        echo "‚ùå Dashboard generation failed"
                        exit 1
                      fi

    - stage:
        name: "Quality Check and Notification"
        identifier: "quality_notification"
        description: "Quality check and success notification"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Quality Check"
                  identifier: "quality_check"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîç Running quality checks..."
                      
                      # Check if required files exist
                      if [ ! -f "final_applications/eligibility_report.md" ]; then
                        echo "‚ùå Ë≥áÊ†ºÂ†±ÂëäÊú™ÁîüÊàê"
                        exit 1
                      fi
                      
                      if [ ! -f "final_applications/dashboard.md" ]; then
                        echo "‚ùå ÂÑÄË°®ÊùøÊú™ÁîüÊàê"
                        exit 1
                      fi
                      
                      # Count generated documents
                      doc_count=$(find final_applications -name "*_study_plan_*.md" | wc -l)
                      echo "Â∑≤ÁîüÊàê $doc_count ‰ªΩËÆÄÊõ∏Ë®àÁï´"
                      
                      if [ $doc_count -eq 0 ]; then
                        echo "‚ùå Êú™ÁîüÊàê‰ªª‰ΩïÁî≥Ë´ãÊñá‰ª∂"
                        exit 1
                      fi
                      
                      echo "‚úÖ Êñá‰ª∂ÂÆåÊï¥ÊÄßÊ™¢Êü•ÈÄöÈÅé"
                      
              - step:
                  type: "Run"
                  name: "Success Notification"
                  identifier: "success_notification"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "=========================================="
                      echo "‰∫§ÊèõÁî≥Ë´ãÊñá‰ª∂ÁîüÊàêÂÆåÊàêÔºÅ"
                      echo "=========================================="
                      echo "ÁîüÊàêÊôÇÈñì: $(date)"
                      echo "Êñá‰ª∂‰ΩçÁΩÆ: final_applications/"
                      echo "ÂÑÄË°®Êùø: final_applications/dashboard.md"
                      echo ""
                      echo "‰∏ã‰∏ÄÊ≠•Âª∫Ë≠∞:"
                      echo "1. Ê™¢Êü•ÂêÑÊ†°Áî≥Ë´ãÊà™Ê≠¢Êó•Êúü"
                      echo "2. Ê∫ñÂÇôËã±Ë™ûÊ™¢ÂÆöÊàêÁ∏æ"
                      echo "3. ËÅØÁπ´Êé®Ëñ¶‰∫∫Êí∞ÂØ´Êé®Ëñ¶‰ø°"
                      echo ""
                      echo "---"
                      echo "Ê≠§ÈÄöÁü•Áî± ExchangeApp-IAC Ëá™ÂãïÁôºÈÄÅ"
                      echo "=========================================="

    - stage:
        name: "Artifact Management"
        identifier: "artifacts"
        description: "Save and organize generated artifacts"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Organize Generated Files"
                  identifier: "organize_files"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üìÅ Organizing generated artifacts..."
                      
                      # Create artifacts directory
                      mkdir -p artifacts/reports artifacts/documents
                      
                      # Copy reports
                      if [ -f "final_applications/eligibility_report.md" ]; then
                        cp final_applications/eligibility_report.md artifacts/reports/
                        echo "‚úÖ Eligibility report archived"
                      fi
                      
                      if [ -f "final_applications/dashboard.md" ]; then
                        cp final_applications/dashboard.md artifacts/reports/
                        echo "‚úÖ Dashboard archived"
                      fi
                      
                      # Copy application documents
                      find final_applications -name "*.md" -path "*/*" | while read file; do
                        if [ -f "$file" ]; then
                          cp "$file" artifacts/documents/
                        fi
                      done
                      
                      # Create manifest
                      cat > artifacts/MANIFEST.txt << EOF
                      Exchange Application Pipeline
                      Generated: $(date)
                      Commit: $(git rev-parse --short HEAD)
                      Pipeline ID: <+pipeline.sequenceId>
                      
                      Files Generated:
                      EOF
                      
                      find artifacts -type f | sort >> artifacts/MANIFEST.txt
                      
                      echo "üìä Artifact Summary:"
                      echo "  Reports: $(ls artifacts/reports/*.md 2>/dev/null | wc -l)"
                      echo "  Documents: $(ls artifacts/documents/*.md 2>/dev/null | wc -l)"

  # Pipeline variables
  variables:
    - name: "profile_file"
      type: "String"
      description: "Profile configuration file"
      value: "my_profile.yml"
      
    - name: "output_directory"
      type: "String"
      description: "Output directory for generated files"
      value: "final_applications"
      
    - name: "template_directory"
      type: "String"
      description: "Template directory"
      value: "templates"

  # Notification rules
  notificationRules:
    - name: "Pipeline Success Notification"
      identifier: "success_notification"
      pipelineEvents:
        - type: "PipelineSuccess"
      notificationMethod:
        type: "Email"
        spec:
          userGroups: []
          recipients:
            - "admin@dennisleehappy.org"
          subject: "‚úÖ Exchange Application Pipeline Completed Successfully"
          body: |
            The Exchange Application Pipeline has completed successfully.
            
            Pipeline ID: <+pipeline.sequenceId>
            Execution Time: <+pipeline.startTs>
            Commit: <+codebase.commitSha>
            
            Generated documents are available in the final_applications directory.
            
            Best regards,
            ExchangeApp-IAC System
      enabled: true
    
    - name: "Pipeline Failure Notification"
      identifier: "failure_notification"
      pipelineEvents:
        - type: "PipelineFailed"
      notificationMethod:
        type: "Email"
        spec:
          userGroups: []
          recipients:
            - "admin@dennisleehappy.org"
          subject: "‚ùå Exchange Application Pipeline Failed"
          body: |
            The Exchange Application Pipeline has failed.
            
            Pipeline ID: <+pipeline.sequenceId>
            Failed Stage: <+pipeline.stage.name>
            
            Please check the pipeline logs for detailed error information.
            
            Best regards,
            ExchangeApp-IAC System
      enabled: true
