pipeline:
  name: "Exchange Application Pipeline"
  identifier: "exchange_application_pipeline"
  projectIdentifier: "exchange_plan"
  orgIdentifier: "default"
  tags: 
    system: "exchange-application"
    version: "1.0.0"
  
  properties:
    ci:
      codebase:
        connectorRef: "github_connector"
        repoName: "Exchange-Plan"
        build: <+input>

  stages:
    - stage:
        name: "Environment Setup"
        identifier: "setup"
        description: "Setup Python environment and install dependencies"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "System Information"
                  identifier: "system_info"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîß Exchange Application System Setup"
                      echo "Date: $(date)"
                      echo "Python version: $(python3 --version)"
                      echo "Pip version: $(pip3 --version)"
                      echo "Git commit: $(git rev-parse --short HEAD)"
                      
              - step:
                  type: "Run"
                  name: "Install Dependencies"
                  identifier: "install_deps"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üì¶ Installing Python dependencies..."
                      
                      # Install core dependencies
                      pip3 install --upgrade pip
                      pip3 install PyYAML
                      
                      echo "‚úÖ Dependencies installed"
                      
                      echo "üìã Installed packages:"
                      pip3 list | grep -E "(PyYAML)"

    - stage:
        name: "Validation and Generation"
        identifier: "validation_generation"
        description: "Validate eligibility and generate application documents"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Validate Configuration"
                  identifier: "validate_config"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîç Validating system configuration..."
                      
                      # Show current directory and list files
                      echo "Current directory: $(pwd)"
                      echo "Directory contents:"
                      ls -la
                      
                      # Navigate to the correct directory if needed
                      WORK_DIR="."
                      if [ -d "Exchange-Plan" ]; then
                        echo "Found Exchange-Plan directory, navigating to it..."
                        cd Exchange-Plan
                        WORK_DIR="Exchange-Plan"
                        echo "Now in: $(pwd)"
                        ls -la
                      fi
                      
                      # Function to find file in current directory or subdirectories
                      find_config_file() {
                        local filename="$1"
                        if [ -f "$filename" ]; then
                          echo "$filename"
                          return 0
                        fi
                        
                        # Search in subdirectories
                        local found=$(find . -name "$filename" -type f 2>/dev/null | head -1)
                        if [ -n "$found" ]; then
                          echo "$found"
                          return 0
                        fi
                        
                        return 1
                      }
                      
                      # Check and locate required files
                      echo "üîç Locating configuration files..."
                      
                      PROFILE_FILE=$(find_config_file "my_profile.yml")
                      if [ -z "$PROFILE_FILE" ]; then
                        echo "‚ùå my_profile.yml not found anywhere"
                        echo "Available .yml files:"
                        find . -name "*.yml" -type f 2>/dev/null || echo "No .yml files found"
                        exit 1
                      fi
                      echo "‚úÖ Found profile file: $PROFILE_FILE"
                      
                      UNIV_FILE=$(find_config_file "university_level_options.yml")
                      if [ -z "$UNIV_FILE" ]; then
                        echo "‚ùå university_level_options.yml not found"
                        echo "Searching in source_data directories:"
                        find . -name "source_data" -type d -exec ls -la {} \; 2>/dev/null || echo "No source_data directories found"
                        exit 1
                      fi
                      echo "‚úÖ Found university options file: $UNIV_FILE"
                      
                      COLLEGE_FILE=$(find_config_file "college_level_options.yml")
                      if [ -z "$COLLEGE_FILE" ]; then
                        echo "‚ùå college_level_options.yml not found"
                        exit 1
                      fi
                      echo "‚úÖ Found college options file: $COLLEGE_FILE"
                      
                      # Validate YAML syntax
                      echo "üîç Validating YAML syntax..."
                      python3 -c "import yaml; yaml.safe_load(open('$PROFILE_FILE'))"
                      echo "‚úÖ $PROFILE_FILE is valid"
                      
                      python3 -c "import yaml; yaml.safe_load(open('$UNIV_FILE'))"
                      echo "‚úÖ $UNIV_FILE is valid"
                      
                      python3 -c "import yaml; yaml.safe_load(open('$COLLEGE_FILE'))"
                      echo "‚úÖ $COLLEGE_FILE is valid"
                      
                      # Export file paths for subsequent steps
                      echo "export PROFILE_FILE='$PROFILE_FILE'" >> ~/.bashrc
                      echo "export UNIV_FILE='$UNIV_FILE'" >> ~/.bashrc
                      echo "export COLLEGE_FILE='$COLLEGE_FILE'" >> ~/.bashrc
                      echo "export WORK_DIR='$WORK_DIR'" >> ~/.bashrc
                      
              - step:
                  type: "Run"
                  name: "Run Eligibility Validation"
                  identifier: "run_validation"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "‚úÖ Starting eligibility validation..."
                      
                      # Source environment variables from previous step
                      source ~/.bashrc 2>/dev/null || true
                      
                      # Navigate to the correct directory if needed
                      if [ -d "Exchange-Plan" ]; then
                        echo "Navigating to Exchange-Plan directory..."
                        cd Exchange-Plan
                      fi
                      
                      echo "Current directory: $(pwd)"
                      export PYTHONPATH="${PYTHONPATH}:$(pwd)"
                      
                      # Check if validator script exists
                      if [ ! -f "intelligence_gathering/validator.py" ]; then
                        echo "‚ùå Validator script not found at intelligence_gathering/validator.py"
                        echo "Searching for validator script:"
                        find . -name "validator.py" -type f 2>/dev/null || echo "No validator.py found"
                        exit 1
                      fi
                      
                      echo "üîç Running application eligibility validator..."
                      python3 intelligence_gathering/validator.py
                      
                      # Check validation results with better error handling
                      if [ -f "final_applications/eligibility_report.md" ]; then
                        echo "‚úÖ Validation completed successfully"
                        echo "üìä Validation summary:"
                        head -20 final_applications/eligibility_report.md
                      else
                        echo "‚ùå Validation failed - eligibility_report.md not found"
                        echo "Checking final_applications directory:"
                        ls -la final_applications/ 2>/dev/null || echo "final_applications directory not found"
                        echo "Checking current directory for any generated files:"
                        find . -name "*.md" -type f 2>/dev/null | head -10
                        exit 1
                      fi
                      
              - step:
                  type: "Run"
                  name: "Generate Application Documents"
                  identifier: "generate_docs"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üìù Generating customized application documents..."
                      
                      # Source environment variables from previous step
                      source ~/.bashrc 2>/dev/null || true
                      
                      # Navigate to the correct directory if needed
                      if [ -d "Exchange-Plan" ]; then
                        echo "Navigating to Exchange-Plan directory..."
                        cd Exchange-Plan
                      fi
                      
                      echo "Current directory: $(pwd)"
                      export PYTHONPATH="${PYTHONPATH}:$(pwd)"
                      
                      # Check if document generator script exists
                      if [ ! -f "build_scripts/generate_docs.py" ]; then
                        echo "‚ùå Document generator script not found at build_scripts/generate_docs.py"
                        echo "Searching for generate_docs script:"
                        find . -name "generate_docs.py" -type f 2>/dev/null || echo "No generate_docs.py found"
                        exit 1
                      fi
                      
                      echo "üìù Running document generator..."
                      python3 build_scripts/generate_docs.py
                      
                      # Document generation summary with better error handling
                      echo "üìä Document Generation Summary:"
                      
                      # Count study plans
                      study_plans=$(find final_applications -name "*_study_plan_*.md" 2>/dev/null | wc -l)
                      echo "  Study plans generated: $study_plans"
                      
                      # Count CV documents
                      cv_docs=$(find final_applications -name "*_cv_*.md" 2>/dev/null | wc -l)
                      echo "  CV documents generated: $cv_docs"
                      
                      # Check dashboard
                      if [ -f "final_applications/dashboard.md" ]; then
                        echo "‚úÖ Dashboard generated successfully"
                      else
                        echo "‚ùå Dashboard generation failed"
                        echo "Checking final_applications directory:"
                        ls -la final_applications/ 2>/dev/null || echo "final_applications directory not found"
                        
                        # Check if any documents were generated at all
                        total_docs=$(find final_applications -name "*.md" 2>/dev/null | wc -l)
                        if [ $total_docs -eq 0 ]; then
                          echo "‚ùå No documents were generated"
                          exit 1
                        else
                          echo "‚ö†Ô∏è Some documents generated but dashboard missing"
                        fi
                      fi

    - stage:
        name: "Quality Check and Notification"
        identifier: "quality_notification"
        description: "Quality check and success notification"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Quality Check"
                  identifier: "quality_check"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üîç Running quality checks..."
                      
                      # Source environment variables from previous step
                      source ~/.bashrc 2>/dev/null || true
                      
                      # Navigate to the correct directory if needed
                      if [ -d "Exchange-Plan" ]; then
                        echo "Navigating to Exchange-Plan directory..."
                        cd Exchange-Plan
                      fi
                      
                      echo "Current directory: $(pwd)"
                      
                      # Comprehensive quality checks
                      echo "üîç Performing comprehensive quality checks..."
                      
                      # Check if final_applications directory exists
                      if [ ! -d "final_applications" ]; then
                        echo "‚ùå final_applications directory not found"
                        echo "Available directories:"
                        ls -la | grep "^d" || echo "No directories found"
                        exit 1
                      fi
                      
                      # Check eligibility report
                      if [ ! -f "final_applications/eligibility_report.md" ]; then
                        echo "‚ùå Ë≥áÊ†ºÂ†±ÂëäÊú™ÁîüÊàê"
                        echo "Checking final_applications directory:"
                        ls -la final_applications/ 2>/dev/null || echo "final_applications directory is empty"
                        exit 1
                      fi
                      echo "‚úÖ Ë≥áÊ†ºÂ†±ÂëäÂ≠òÂú®"
                      
                      # Check dashboard
                      if [ ! -f "final_applications/dashboard.md" ]; then
                        echo "‚ùå ÂÑÄË°®ÊùøÊú™ÁîüÊàê"
                        exit 1
                      fi
                      echo "‚úÖ ÂÑÄË°®ÊùøÂ≠òÂú®"
                      
                      # Count generated documents
                      study_plans=$(find final_applications -name "*_study_plan_*.md" 2>/dev/null | wc -l)
                      cv_docs=$(find final_applications -name "*_cv_*.md" 2>/dev/null | wc -l)
                      total_docs=$(find final_applications -name "*.md" 2>/dev/null | wc -l)
                      
                      echo "üìä Êñá‰ª∂Áµ±Ë®à:"
                      echo "  ËÆÄÊõ∏Ë®àÁï´: $study_plans ‰ªΩ"
                      echo "  Â±•Ê≠∑Êñá‰ª∂: $cv_docs ‰ªΩ"
                      echo "  Á∏ΩÊñá‰ª∂Êï∏: $total_docs ‰ªΩ"
                      
                      if [ $study_plans -eq 0 ]; then
                        echo "‚ùå Êú™ÁîüÊàê‰ªª‰ΩïËÆÄÊõ∏Ë®àÁï´"
                        echo "Available files in final_applications:"
                        find final_applications -type f 2>/dev/null | head -20 || echo "No files found"
                        exit 1
                      fi
                      
                      if [ $cv_docs -eq 0 ]; then
                        echo "‚ö†Ô∏è Êú™ÁîüÊàê‰ªª‰ΩïÂ±•Ê≠∑Êñá‰ª∂"
                      fi
                      
                      # Check file sizes to ensure they're not empty
                      empty_files=$(find final_applications -name "*.md" -size 0 2>/dev/null | wc -l)
                      if [ $empty_files -gt 0 ]; then
                        echo "‚ö†Ô∏è ÁôºÁèæ $empty_files ÂÄãÁ©∫Êñá‰ª∂"
                        find final_applications -name "*.md" -size 0 2>/dev/null
                      fi
                      
                      echo "‚úÖ Êñá‰ª∂ÂÆåÊï¥ÊÄßÊ™¢Êü•ÈÄöÈÅé"
                      
              - step:
                  type: "Run"
                  name: "Success Notification"
                  identifier: "success_notification"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "=========================================="
                      echo "‰∫§ÊèõÁî≥Ë´ãÊñá‰ª∂ÁîüÊàêÂÆåÊàêÔºÅ"
                      echo "=========================================="
                      echo "ÁîüÊàêÊôÇÈñì: $(date)"
                      echo "Êñá‰ª∂‰ΩçÁΩÆ: final_applications/"
                      echo "ÂÑÄË°®Êùø: final_applications/dashboard.md"
                      echo ""
                      echo "‰∏ã‰∏ÄÊ≠•Âª∫Ë≠∞:"
                      echo "1. Ê™¢Êü•ÂêÑÊ†°Áî≥Ë´ãÊà™Ê≠¢Êó•Êúü"
                      echo "2. Ê∫ñÂÇôËã±Ë™ûÊ™¢ÂÆöÊàêÁ∏æ"
                      echo "3. ËÅØÁπ´Êé®Ëñ¶‰∫∫Êí∞ÂØ´Êé®Ëñ¶‰ø°"
                      echo ""
                      echo "---"
                      echo "Ê≠§ÈÄöÁü•Áî± ExchangeApp-IAC Ëá™ÂãïÁôºÈÄÅ"
                      echo "=========================================="

    - stage:
        name: "Artifact Management"
        identifier: "artifacts"
        description: "Save and organize generated artifacts"
        type: "CI"
        spec:
          cloneCodebase: true
          platform:
            os: "Linux"
            arch: "Amd64"
          runtime:
            type: "Cloud"
            spec: {}
          execution:
            steps:
              - step:
                  type: "Run"
                  name: "Organize Generated Files"
                  identifier: "organize_files"
                  spec:
                    shell: "Bash"
                    command: |
                      echo "üìÅ Organizing generated artifacts..."
                      
                      # Source environment variables from previous step
                      source ~/.bashrc 2>/dev/null || true
                      
                      # Navigate to the correct directory if needed
                      if [ -d "Exchange-Plan" ]; then
                        echo "Navigating to Exchange-Plan directory..."
                        cd Exchange-Plan
                      fi
                      
                      echo "Current directory: $(pwd)"
                      
                      # Create artifacts directory structure
                      echo "Creating artifact directory structure..."
                      mkdir -p artifacts/reports artifacts/documents artifacts/data
                      
                      # Copy reports with better error handling
                      echo "üìã Copying reports..."
                      if [ -f "final_applications/eligibility_report.md" ]; then
                        cp final_applications/eligibility_report.md artifacts/reports/
                        echo "‚úÖ Eligibility report archived"
                      else
                        echo "‚ö†Ô∏è Eligibility report not found"
                      fi
                      
                      if [ -f "final_applications/dashboard.md" ]; then
                        cp final_applications/dashboard.md artifacts/reports/
                        echo "‚úÖ Dashboard archived"
                      else
                        echo "‚ö†Ô∏è Dashboard not found"
                      fi
                      
                      # Copy application documents with better handling
                      echo "üìÑ Copying application documents..."
                      doc_count=0
                      find final_applications -name "*.md" -type f | while read file; do
                        if [ -f "$file" ]; then
                          cp "$file" artifacts/documents/
                          doc_count=$((doc_count + 1))
                        fi
                      done
                      
                      # Count actual copied files
                      actual_docs=$(ls artifacts/documents/*.md 2>/dev/null | wc -l)
                      echo "‚úÖ Copied $actual_docs application documents"
                      
                      # Create comprehensive manifest
                      echo "üìù Creating manifest..."
                      cat > artifacts/MANIFEST.txt << EOF
                      Exchange Application Pipeline
                      Generated: $(date)
                      Commit: $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                      Pipeline ID: <+pipeline.sequenceId>
                      Working Directory: $(pwd)
                      
                      File Summary:
                      EOF
                      
                      # Add file counts to manifest
                      echo "  Reports: $(ls artifacts/reports/*.md 2>/dev/null | wc -l)" >> artifacts/MANIFEST.txt
                      echo "  Documents: $(ls artifacts/documents/*.md 2>/dev/null | wc -l)" >> artifacts/MANIFEST.txt
                      echo "  Data Files: $(ls artifacts/data/* 2>/dev/null | wc -l)" >> artifacts/MANIFEST.txt
                      echo "" >> artifacts/MANIFEST.txt
                      
                      echo "All Files:" >> artifacts/MANIFEST.txt
                      find artifacts -type f | sort >> artifacts/MANIFEST.txt
                      
                      # Final summary
                      echo "üìä Artifact Summary:"
                      echo "  Reports: $(ls artifacts/reports/*.md 2>/dev/null | wc -l)"
                      echo "  Documents: $(ls artifacts/documents/*.md 2>/dev/null | wc -l)"
                      echo "  Total Files: $(find artifacts -type f | wc -l)"
                      
                      # Show manifest
                      echo "üìã Manifest created:"
                      cat artifacts/MANIFEST.txt

  # Pipeline variables
  variables:
    - name: "profile_file"
      type: "String"
      description: "Profile configuration file"
      value: "my_profile.yml"
      
    - name: "output_directory"
      type: "String"
      description: "Output directory for generated files"
      value: "final_applications"
      
    - name: "template_directory"
      type: "String"
      description: "Template directory"
      value: "templates"

  # Notification rules
  notificationRules:
    - name: "Pipeline Success Notification"
      identifier: "success_notification"
      pipelineEvents:
        - type: "PipelineSuccess"
      notificationMethod:
        type: "Email"
        spec:
          userGroups: []
          recipients:
            - "admin@dennisleehappy.org"
          subject: "‚úÖ Exchange Application Pipeline Completed Successfully"
          body: |
            The Exchange Application Pipeline has completed successfully.
            
            Pipeline ID: <+pipeline.sequenceId>
            Execution Time: <+pipeline.startTs>
            Commit: <+codebase.commitSha>
            
            Generated documents are available in the final_applications directory.
            
            Best regards,
            ExchangeApp-IAC System
      enabled: true
    
    - name: "Pipeline Failure Notification"
      identifier: "failure_notification"
      pipelineEvents:
        - type: "PipelineFailed"
      notificationMethod:
        type: "Email"
        spec:
          userGroups: []
          recipients:
            - "admin@dennisleehappy.org"
          subject: "‚ùå Exchange Application Pipeline Failed"
          body: |
            The Exchange Application Pipeline has failed.
            
            Pipeline ID: <+pipeline.sequenceId>
            Failed Stage: <+pipeline.stage.name>
            
            Please check the pipeline logs for detailed error information.
            
            Best regards,
            ExchangeApp-IAC System
      enabled: true
