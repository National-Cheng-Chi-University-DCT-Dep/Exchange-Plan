# Harness Pipeline é…ç½®æª”æ¡ˆ
# äº¤æ›ç”³è«‹è‡ªå‹•åŒ–æµç¨‹

pipeline:
  name: "Exchange Application Pipeline"
  identifier: "exchange_application_pipeline"
  description: "è‡ªå‹•åŒ–äº¤æ›ç”³è«‹æ–‡ä»¶ç”Ÿæˆèˆ‡è³‡æ ¼é©—è­‰æµç¨‹"
  
  # è§¸ç™¼æ¢ä»¶
  triggers:
    - name: "Manual Trigger"
      identifier: "manual_trigger"
      type: "Manual"
      description: "æ‰‹å‹•è§¸ç™¼ç”³è«‹æ–‡ä»¶ç”Ÿæˆ"
      
    - name: "Options Update Trigger"
      identifier: "options_update_trigger"
      type: "Webhook"
      description: "ç•¶options.ymlæª”æ¡ˆæ›´æ–°æ™‚è§¸ç™¼"
      webhook:
        path: "webhook/options-updated"
        method: "POST"
  
  # Pipeline éšæ®µ
  stages:
    - stage:
        name: "Validate Eligibility"
        identifier: "validate_eligibility"
        type: "CI"
        description: "é©—è­‰ç”³è«‹è³‡æ ¼"
        
        spec:
          execution:
            steps:
              - step:
                  name: "Setup Python Environment"
                  identifier: "setup_python"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # æª¢æŸ¥Pythonç’°å¢ƒ
                      python3 --version
                      pip3 --version
                      
                      # å®‰è£å¿…è¦å¥—ä»¶
                      pip3 install pyyaml
                      
              - step:
                  name: "Run Eligibility Validation"
                  identifier: "run_validation"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # åŸ·è¡Œè³‡æ ¼é©—è­‰è…³æœ¬
                      cd /harness
                      python3 intelligence_gathering/validator.py
                      
                  output_variables:
                    - name: "eligibility_report_path"
                      value: "final_applications/eligibility_report.md"
              
              - step:
                  name: "Publish Eligibility Report"
                  identifier: "publish_report"
                  type: "Artifacts"
                  spec:
                    source:
                      type: "Gcr"
                      spec:
                        connectorRef: "harnessImage"
                        imagePath: "final_applications/eligibility_report.md"
    
    - stage:
        name: "Generate Documents"
        identifier: "generate_documents"
        type: "CI"
        description: "ç”Ÿæˆå®¢è£½åŒ–ç”³è«‹æ–‡ä»¶"
        dependsOn:
          - "validate_eligibility"
        
        spec:
          execution:
            steps:
              - step:
                  name: "Generate Application Documents"
                  identifier: "generate_docs"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # åŸ·è¡Œæ–‡ä»¶ç”Ÿæˆè…³æœ¬
                      cd /harness
                      python3 build_scripts/generate_docs.py
                      
              - step:
                  name: "Generate Dashboard"
                  identifier: "generate_dashboard"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # æ›´æ–°å„€è¡¨æ¿
                      cd /harness
                      python3 build_scripts/generate_docs.py
                      
              - step:
                  name: "Archive Generated Documents"
                  identifier: "archive_docs"
                  type: "Artifacts"
                  spec:
                    source:
                      type: "Gcr"
                      spec:
                        connectorRef: "harnessImage"
                        imagePath: "final_applications/"
    
    - stage:
        name: "Quality Check"
        identifier: "quality_check"
        type: "CI"
        description: "æ–‡ä»¶å“è³ªæª¢æŸ¥"
        dependsOn:
          - "generate_documents"
        
        spec:
          execution:
            steps:
              - step:
                  name: "Check Document Completeness"
                  identifier: "check_completeness"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # æª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦å®Œæ•´
                      cd /harness
                      
                      # æª¢æŸ¥å¿…è¦æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                      if [ ! -f "final_applications/eligibility_report.md" ]; then
                        echo "âŒ è³‡æ ¼å ±å‘Šæœªç”Ÿæˆ"
                        exit 1
                      fi
                      
                      if [ ! -f "final_applications/dashboard.md" ]; then
                        echo "âŒ å„€è¡¨æ¿æœªç”Ÿæˆ"
                        exit 1
                      fi
                      
                      # è¨ˆç®—ç”Ÿæˆçš„ç”³è«‹æ–‡ä»¶æ•¸é‡
                      doc_count=$(find final_applications -name "*_study_plan_*.md" | wc -l)
                      echo "ğŸ“„ å·²ç”Ÿæˆ $doc_count ä»½è®€æ›¸è¨ˆç•«"
                      
                      if [ $doc_count -eq 0 ]; then
                        echo "âŒ æœªç”Ÿæˆä»»ä½•ç”³è«‹æ–‡ä»¶"
                        exit 1
                      fi
                      
                      echo "âœ… æ–‡ä»¶å®Œæ•´æ€§æª¢æŸ¥é€šé"
              
              - step:
                  name: "Validate Document Format"
                  identifier: "validate_format"
                  type: "Run"
                  spec:
                    shell: "Bash"
                    command: |
                      # æª¢æŸ¥æ–‡ä»¶æ ¼å¼
                      cd /harness
                      
                      # æª¢æŸ¥Markdownèªæ³•
                      for file in $(find final_applications -name "*.md"); do
                        echo "æª¢æŸ¥æª”æ¡ˆ: $file"
                        # ç°¡å–®çš„Markdownæª¢æŸ¥
                        if ! grep -q "#" "$file"; then
                          echo "âš ï¸  è­¦å‘Š: $file å¯èƒ½ç¼ºå°‘æ¨™é¡Œ"
                        fi
                      done
                      
                      echo "âœ… æ–‡ä»¶æ ¼å¼æª¢æŸ¥å®Œæˆ"
    
    - stage:
        name: "Notification"
        identifier: "notification"
        type: "CI"
        description: "ç™¼é€å®Œæˆé€šçŸ¥"
        dependsOn:
          - "quality_check"
        
        spec:
          execution:
            steps:
              - step:
                  name: "Send Success Notification"
                  identifier: "send_notification"
                  type: "Email"
                  spec:
                    to: "admin@dennisleehappy.org"
                    subject: "äº¤æ›ç”³è«‹æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
                    body: |
                      æ‚¨çš„äº¤æ›ç”³è«‹æ–‡ä»¶å·²æˆåŠŸç”Ÿæˆï¼
                      
                      ç”Ÿæˆæ™‚é–“: $(date)
                      æ–‡ä»¶ä½ç½®: final_applications/
                      å„€è¡¨æ¿: final_applications/dashboard.md
                      
                      è«‹æª¢æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ä¸¦æ ¹æ“šéœ€è¦é€²è¡Œèª¿æ•´ã€‚
                      
                      ä¸‹ä¸€æ­¥å»ºè­°:
                      1. æª¢æŸ¥å„æ ¡ç”³è«‹æˆªæ­¢æ—¥æœŸ
                      2. æº–å‚™è‹±èªæª¢å®šæˆç¸¾
                      3. è¯ç¹«æ¨è–¦äººæ’°å¯«æ¨è–¦ä¿¡
                      
                      ---
                      æ­¤é€šçŸ¥ç”± ExchangeApp-IAC è‡ªå‹•ç™¼é€

  # Pipeline è®Šæ•¸
  variables:
    - name: "profile_file"
      type: "String"
      value: "my_profile.yml"
      
    - name: "output_directory"
      type: "String"
      value: "final_applications"
      
    - name: "template_directory"
      type: "String"
      value: "templates"

  # å¤±æ•—ç­–ç•¥
  failureStrategies:
    - onFailure:
        errors:
          - "AllErrors"
        action:
          type: "Ignore"
          spec: {}

  # é€šçŸ¥è¨­å®š
  notificationRules:
    - name: "Pipeline Success"
      events:
        - "Pipeline Success"
      notificationMethod:
        type: "Email"
        spec:
          recipients:
            - "admin@dennisleehappy.org"
          subject: "âœ… äº¤æ›ç”³è«‹æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
    
    - name: "Pipeline Failure"
      events:
        - "Pipeline Failure"
      notificationMethod:
        type: "Email"
        spec:
          recipients:
            - "admin@dennisleehappy.org"
          subject: "âŒ äº¤æ›ç”³è«‹æ–‡ä»¶ç”Ÿæˆå¤±æ•—"
