name: Generate Application PDFs

on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      pdf_type:
        description: 'PDFé¡å‹'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - cv
        - transcript
        - supporting
      
  # ç•¶ç›¸é—œæ–‡ä»¶æ›´æ–°æ™‚è‡ªå‹•è§¸ç™¼
  push:
    paths:
      - 'my_profile.yml'
      - 'final_applications/**/*.md'
      - 'supporting_documents/**'
      - 'build_scripts/generate_pdfs.py'
      - '.github/workflows/generate-pdfs.yml'
    branches:
      - main
      - dev
  
  # PRæ™‚è§¸ç™¼ï¼ˆåƒ…æ¸¬è©¦ï¼Œä¸æäº¤ï¼‰
  pull_request:
    paths:
      - 'my_profile.yml'
      - 'final_applications/**/*.md'
      - 'supporting_documents/**'
      - 'build_scripts/generate_pdfs.py'

jobs:
  generate-pdfs:
    name: ğŸ”„ Generate Application PDFs
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install System Dependencies
        run: |
          # å®‰è£WeasyPrintæ‰€éœ€çš„ç³»çµ±å¥—ä»¶
          sudo apt-get update
          sudo apt-get install -y \
            libpango-1.0-0 \
            libharfbuzz0b \
            libpangoft2-1.0-0 \
            libfontconfig1 \
            libcairo2 \
            libgdk-pixbuf2.0-0 \
            shared-mime-info \
            fonts-dejavu-core \
            fonts-liberation \
            fonts-noto-cjk
          
          echo "âœ… ç³»çµ±ä¾è³´å®‰è£å®Œæˆ"
      
      - name: ğŸ“š Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-pdf.txt
          echo "âœ… Pythonå¥—ä»¶å®‰è£å®Œæˆ"
      
      - name: ğŸ” Validate Environment
        run: |
          echo "ğŸ”§ é©—è­‰PDFç”Ÿæˆç’°å¢ƒ..."
          python -c "import weasyprint; print('âœ… WeasyPrint OK')"
          python -c "import reportlab; print('âœ… ReportLab OK')"  
          python -c "import PIL; print('âœ… Pillow OK')"
          python -c "import yaml; print('âœ… PyYAML OK')"
          python -c "import markdown; print('âœ… Markdown OK')"
          
          echo "ğŸ“‚ æª¢æŸ¥å¿…è¦æª”æ¡ˆ..."
          ls -la my_profile.yml
          ls -la build_scripts/generate_pdfs.py
          
          if [ -d "final_applications" ]; then
            echo "âœ… final_applicationsç›®éŒ„å­˜åœ¨"
            find final_applications -name "*.md" | head -5
          else
            echo "âš ï¸ final_applicationsç›®éŒ„ä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆç”Ÿæˆç”³è«‹æ–‡ä»¶"
          fi
          
          if [ -d "supporting_documents" ]; then
            echo "âœ… supporting_documentsç›®éŒ„å­˜åœ¨"
            ls -la supporting_documents/
          else
            echo "âš ï¸ supporting_documentsç›®éŒ„ä¸å­˜åœ¨"
          fi
      
      - name: ğŸ“„ Generate Application Documents (if needed)
        if: ${{ !cancelled() }}
        run: |
          if [ ! -d "final_applications" ] || [ -z "$(ls -A final_applications 2>/dev/null)" ]; then
            echo "ğŸ“ final_applicationsç›®éŒ„ç‚ºç©ºï¼Œå…ˆç”Ÿæˆç”³è«‹æ–‡ä»¶..."
            
            if [ -f "build_scripts/generate_docs.py" ]; then
              python build_scripts/generate_docs.py
              echo "âœ… ç”³è«‹æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
            else
              echo "âš ï¸ æ‰¾ä¸åˆ°generate_docs.pyï¼Œè·³éç”³è«‹æ–‡ä»¶ç”Ÿæˆ"
            fi
          else
            echo "âœ… ç”³è«‹æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³éç”Ÿæˆæ­¥é©Ÿ"
          fi
      
      - name: ğŸ¯ Generate PDFs
        id: generate_pdfs
        run: |
          echo "ğŸš€ é–‹å§‹ç”ŸæˆPDFæ–‡ä»¶..."
          
          # è¨­å®šPDFé¡å‹
          PDF_TYPE="${{ github.event.inputs.pdf_type || 'all' }}"
          echo "ğŸ“‹ PDFé¡å‹: $PDF_TYPE"
          
          # å»ºç«‹è¼¸å‡ºç›®éŒ„
          mkdir -p application_pdfs
          
          # åŸ·è¡ŒPDFç”Ÿæˆ
          python build_scripts/generate_pdfs.py \
            --type "$PDF_TYPE" \
            --profile my_profile.yml \
            --output application_pdfs
          
          # æª¢æŸ¥ç”Ÿæˆçµæœ
          if [ -d "application_pdfs" ] && [ "$(ls -A application_pdfs 2>/dev/null)" ]; then
            echo "âœ… PDFç”ŸæˆæˆåŠŸï¼"
            echo "ğŸ“ ç”Ÿæˆçš„PDFæ–‡ä»¶:"
            ls -lh application_pdfs/
            
            # è¨­å®šè¼¸å‡ºè®Šæ•¸
            echo "pdf_generated=true" >> $GITHUB_OUTPUT
            echo "pdf_count=$(ls application_pdfs/*.pdf 2>/dev/null | wc -l)" >> $GITHUB_OUTPUT
            
            # è¨ˆç®—ç¸½æª”æ¡ˆå¤§å°
            total_size=$(du -sh application_pdfs/ | cut -f1)
            echo "total_size=$total_size" >> $GITHUB_OUTPUT
            echo "ğŸ“ ç¸½æª”æ¡ˆå¤§å°: $total_size"
            
          else
            echo "âŒ PDFç”Ÿæˆå¤±æ•—æˆ–æ²’æœ‰ç”Ÿæˆä»»ä½•æª”æ¡ˆ"
            echo "pdf_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: ğŸ“Š PDF Quality Check
        if: steps.generate_pdfs.outputs.pdf_generated == 'true'
        run: |
          echo "ğŸ” åŸ·è¡ŒPDFå“è³ªæª¢æŸ¥..."
          
          for pdf in application_pdfs/*.pdf; do
            if [ -f "$pdf" ]; then
              size=$(stat --format="%s" "$pdf")
              size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc -l)
              
              echo "ğŸ“„ æª”æ¡ˆ: $(basename "$pdf")"
              echo "   å¤§å°: ${size_mb}MB"
              
              # æª¢æŸ¥æª”æ¡ˆå¤§å°é™åˆ¶
              if [[ "$pdf" == *"CV"* ]] && (( $(echo "$size_mb > 4" | bc -l) )); then
                echo "âš ï¸ è­¦å‘Š: CVæª”æ¡ˆè¶…é4MBé™åˆ¶"
              elif [[ "$pdf" != *"CV"* ]] && (( $(echo "$size_mb > 10" | bc -l) )); then
                echo "âš ï¸ è­¦å‘Š: æª”æ¡ˆè¶…é10MBé™åˆ¶"
              else
                echo "âœ… æª”æ¡ˆå¤§å°ç¬¦åˆè¦æ±‚"
              fi
              
              # æª¢æŸ¥PDFå®Œæ•´æ€§
              if command -v pdfinfo >/dev/null 2>&1; then
                pages=$(pdfinfo "$pdf" 2>/dev/null | grep "Pages:" | awk '{print $2}')
                echo "   é æ•¸: ${pages:-Unknown}"
              fi
              
              echo ""
            fi
          done
      
      - name: ğŸ“¤ Upload PDF Artifacts
        if: steps.generate_pdfs.outputs.pdf_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: application-pdfs-${{ github.run_number }}
          path: application_pdfs/
          retention-days: 30
          compression-level: 6
      
      - name: ğŸ’¾ Commit Generated PDFs
        if: steps.generate_pdfs.outputs.pdf_generated == 'true' && github.event_name != 'pull_request'
        run: |
          echo "ğŸ’¾ æäº¤ç”Ÿæˆçš„PDFæ–‡ä»¶åˆ°Repository..."
          
          # è¨­å®šGité…ç½®
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          git add application_pdfs/
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²’æœ‰æ–°çš„PDFæª”æ¡ˆéœ€è¦æäº¤"
          else
            # å»ºç«‹æäº¤
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
            
            # å»ºç«‹æäº¤è¨Šæ¯
            cat > commit_message.txt << EOF
          ğŸ¤– Auto-generate: Application PDFs
          
          ğŸ“… Generated: $TIMESTAMP
          ğŸ”§ Workflow: ${{ github.workflow }}
          ğŸ“‹ Run ID: ${{ github.run_id }}
          ğŸ“Š Files: ${{ steps.generate_pdfs.outputs.pdf_count }} PDFs
          ğŸ“ Total Size: ${{ steps.generate_pdfs.outputs.total_size }}
          
          Generated PDFs:
          $(ls application_pdfs/ | sed 's/^/- /' 2>/dev/null || echo '- No PDFs found')
          EOF
            
            git commit -F commit_message.txt
            rm commit_message.txt
            
            # æ¨é€åˆ°repository
            git push origin ${{ github.ref_name }}
            
            echo "âœ… PDFæ–‡ä»¶å·²æäº¤ä¸¦æ¨é€åˆ°GitHub"
          fi
      
      - name: ğŸ“‹ Create Summary
        if: always()
        run: |
          echo "## ğŸ“„ PDF Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.generate_pdfs.outputs.pdf_generated }}" == "true" ]; then
            echo "### âœ… Generation Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Files Generated:** ${{ steps.generate_pdfs.outputs.pdf_count }} PDFs" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Size:** ${{ steps.generate_pdfs.outputs.total_size }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Output Directory:** \`application_pdfs/\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸ“ Generated Files:" >> $GITHUB_STEP_SUMMARY
            for pdf in application_pdfs/*.pdf; do
              if [ -f "$pdf" ]; then
                size=$(stat --format="%s" "$pdf")
                size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc -l)
                echo "- \`$(basename "$pdf")\` (${size_mb}MB)" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
          else
            echo "### âŒ Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è«‹æª¢æŸ¥workflowæ—¥èªŒä»¥äº†è§£å¤±æ•—åŸå› ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Application Requirements" >> $GITHUB_STEP_SUMMARY
          echo "- **CV:** Maximum 4MB PDF" >> $GITHUB_STEP_SUMMARY
          echo "- **Transcript:** Maximum 10MB PDF" >> $GITHUB_STEP_SUMMARY  
          echo "- **Supporting Docs:** Maximum 10MB PDF" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions â€¢ $(date)*" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: ğŸ“¢ Notify Completion
    needs: generate-pdfs
    runs-on: ubuntu-latest
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“§ Send Notification
        if: needs.generate-pdfs.result == 'success'
        run: |
          echo "ğŸ‰ PDF generation completed successfully!"
          echo "ğŸ“ Check the application_pdfs/ directory for generated files"
          echo "ğŸ’¾ Files have been committed to the repository"
          
          # é€™è£¡å¯ä»¥åŠ å…¥ç™¼é€Emailæˆ–Slacké€šçŸ¥çš„é‚è¼¯
          # ä¾‹å¦‚ä½¿ç”¨ GitHub Actions çš„é€šçŸ¥åŠŸèƒ½
